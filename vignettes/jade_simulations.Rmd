---
title: "Reproducing JADE Simulations"
author: "Jean"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title} 
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette walks throug the process of reproducing the simulation results presented in XXXXX.
All of the files produced in the following steps are available in the supplemental material of that paper. 

You will need the `bsseq` package and the `methylKit` package:
```{r, eval=FALSE}
#BSmooth
source("https://bioconductor.org/biocLite.R")
biocLite("bsseq")

# methylKit dependencies
install.packages( c("data.table","devtools"))
source("http://bioconductor.org/biocLite.R")
biocLite(c("GenomicRanges","IRanges"))

# methylKit
library(devtools)
install_github("al2na/methylKit",build_vignettes=FALSE)
```

## Binomial simulations with random effects.
These simulations are shown in secion XX. 
The steps outlined below require a specific directory structure. These commands should all be run in a directory that contains the subdirectories `data/`, `f0/`, `path/`, `alt/`, and `cv/`.

The mean curves shown in figure XX are in the `binom_profiles` object in this package.

```{r, fig.show='hold', fig.width=6, fig.height=3, warning=FALSE}
library(jadeSims)
library(ggplot2)
ggplot(data.frame(binom_profiles), aes(x=1:300)) +
  geom_line(aes(y=X1)) + 
  geom_line(aes(y=X2), color="blue") + 
  labs(x="Position", y="Profile")
```

Step 1: Produce the data. 
The function `tile_binomial_data` in this package produces data for a single group. The following produces one data set for both groups using a sample size of 10 in each group and no random effects.
```{r}
#One data set:
sample.size <- c(10, 10)
full.counts <- matrix(nrow=300, ncol=0)
full.reads <- matrix(nrow=300, ncol=0)
for(i in 1:2){
  my.data <- replicate(n=sample.size[i], expr={
      z <-  tile_binomial_data(profile=binom_profiles[,i], mean.reads=10,
      reff.sd=0, mean.tile.length=30)
      cbind(z$y, z$reads)})
  my.counts <-  my.data[, 1, ]
  my.reads <-  my.data[, 2, ]
  full.counts <- cbind(full.counts, my.counts)
  full.reads <- cbind(full.reads, my.reads)
}
R <- list("Y"=full.counts, "READS"=full.reads, "sample.size"=sample.size)
```


To produce the data sets used in the paper use the wrapper `generate_data_binomial` which includes the correct seed. This function must be used in a dirctory containing a `data/` subdirectory.

```{r, eval=FALSE}
generate_data_binomial()
generate_data_binomial(seed=60282, start.rep=61, stop.rep=100)
```

The wrapper also calls a function `alternatives_binomial` which runs `bsseq` and  `methylKit` and saves results to a file in the `alt/` directory. 

Step 2: Run JADE: This can take a while so it is better to do it in parallel. The function `run_jade_binomial` calculates the trendfiltering fits at `gamma=0` and runs the full path of solutions for the complete data as well as the cross validation data sets.

```{r, eval=FALSE}
file.prefix <- "binom_0_n1"
run_jade_binomial(file.prefix=file.prefix)
```


Step 3: Aggregate all the results into a  useful data structure. Use the `aggregate_sims` function:

```{r, eval=FALSE}
aggregate_sims(file.prefix="binom_0", which.rep=1:100, profiles=binom_profiles, save.file="binom_0_agg.RData", tol=5e-3, level=0.1, run.cv=TRUE)
```

Step 4: Make Plots

```{r, eval=FALSE}
agg.obj <- getobj("binom_0_agg.RData")
plot_roc_curves(agg.obj, which.stats=)
```

## Normal simulations with auto regressive errors and with random effects
These simulations are produced using the same steps as above but with different functions.

Step 1: Generate data. This process uses the `normal_data` function. There are wrappers producing the exact set of data used in the paper.
```{r, eval=FALSE}
generate_data_ar()
generate_data_ar(seed=95870, start.rep=61, stop.rep=100)
generate_data_re()
generate_data_re(seed=46916, start.rep=61, stop.rep=100)
```

Step 3: Run JADE:

For Auto-regressive errors
```{r, eval=FALSE}
for(arsd in c(0.5, 1, 2)){
    for(rho in c(0, 0.2, 0.4)){
      for(rep in 1:100){
      file.prefix <- paste0("ar_sd", arsd, "_rho_", rho, "_n", rep)
      run_jade_normal(file.prefix=file.prefix)
    }
}
```

For random effects:


```{r, eval=FALSE}
perc <- c(5, 10, 15, 20)
for(l in 1:4){
  for(rep in 1:100){
    file.prefix <- paste0("re_", perc[l], "_n", rep)
    run_jade_normal(file.prefix=file.prefix)
  }
}
```

Step 3: Aggregate

Step 4: Plot

```{r, eval=FALSE}
arsd=0.5; rho=0.2
agg.obj <- getobj(paste0("ar_sd", arsd, "_rho_", rho, "_tol_5e-3_agg.RData"))
plot_roc_curves(agg.obj, which.stats=c("jade", "tt.slim", "spline.slim", "locfit.slim"),
          cols=c("black", "orchid3", "darkgreen", "blue"),
          direction="vertical", ltys=c(1, 3, 2, 2), lwd=2,
          main=bquote(~sigma == .(arsd) ~rho == .(rho)) )
)
```

